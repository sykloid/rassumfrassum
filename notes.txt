# Development Notes

## Recent Implementation Work

### Multi-server Completion Support (4-part feature)
Completed all 4 pieces needed for multi-server completion:

1. **Capability merging** (frassum.py:_merge_initialize_payloads)
   - Deep merges completionProvider capabilities from multiple servers
   - FIXME: Boolean true vs {"workDoneProgress": true} needs special handling
   - Should retain truish value but set workDoneProgress: false when one server lacks it

2. **Request routing** (frassum.py:servers_to_route_to)
   - Routes textDocument/completion to servers with completionProvider capability
   - INCOMPLETE: Has logic for triggerCharacter filtering but needs testing
   - Should route based on triggerCharacters when context.triggerCharacter is present

3. **Data stashing** (frassum.py:on_server_response)
   - Stashes 'data' fields in completion items for later resolve requests
   - Uses inline format: {"frassum-server": id(server), "frassum-data": original_data}
   - Same mechanism used for codeAction items
   - Recovery uses server_by_id mapping (walrus operator pattern)

4. **Response aggregation** (frassum.py:aggregate_payload)
   - Normalizes both list and CompletionList dict formats
   - Deep merges using dmerge() utility
   - FIXME: isIncomplete and other CompletionList properties need field-specific logic

### Data Cookie Refactoring
Replaced DataCookie database with inline stashing:
- OLD: Stored {cookie_id: DataCookie} mapping, replaced data with string ID
- NEW: Replaces data with {"frassum-server": id(server), "frassum-data": original}
- Recovery uses server_by_id dict for O(1) lookup
- Cleaner, no global state, no ID counter needed

### Architecture Changes
- LspLogic.__init__ now takes all servers (not just primary)
- Removed primary_server slot, use servers[0] instead
- Added server_by_id mapping for data recovery

## Testing Gaps (IMPORTANT)

### Current Test Coverage
- Most tests use mock servers (test/*/server.py)
- Only one test uses real servers: test/basedpyright+ruff/
- Real server test only does initialize → initialized → shutdown → exit
- Does NOT exercise:
  * Completion aggregation
  * CodeAction aggregation
  * Data stashing/recovery (resolve requests)
  * Completion routing with triggerCharacters
  * Diagnostics from real servers

### Action Items
1. Add more real server tests (basedpyright + ruff combinations)
2. Test completion aggregation with real servers
3. Test codeAction/resolve with real servers (exercises data recovery)
4. Test completion/resolve with real servers
5. ALWAYS read stderr output - it shows actual capability merging
6. Example from basedpyright+ruff test showed:
   - hoverProvider conflict (true vs {"workDoneProgress": true})
   - Array concatenation issues (duplicate trigger characters)
   - These need field-specific merge logic

### Test Infrastructure
- Exit code 77 = SKIPPED (when servers not installed)
- test/run-all.sh tracks passed/failed/skipped/timedout
- Real server tests check `command -v` for executables

## Code Style Notes (Python)
- Use walrus operator chaining for conditional lookups:
  ```python
  if (x := get_thing()) and (y := process(x)):
      # use x and y
  ```
- Cleaner than nested ifs, avoids repetitive lookups
- Example: data recovery in servers_to_route_to()

## Known Issues / FIXMEs
1. Capability merging (frassum.py ~line 298)
   - Boolean vs dict conflicts need capability-specific logic
   - Different strategies needed per capability type

2. Completion aggregation (frassum.py ~line 260)
   - Deep merge of CompletionList properties is wrong
   - isIncomplete should be OR'd, not overwritten
   - Other fields may need special handling

3. Data stashing check (frassum.py:_stash_data_maybe)
   - FIXME: investigate why payload can be None

## Repository Structure
- src/rassumfrassum/main.py - Entry point, CLI parsing
- src/rassumfrassum/rassum.py - Core multiplexer, async tasks
- src/rassumfrassum/frassum.py - LSP-specific logic, routing, aggregation
- src/rassumfrassum/json.py - JSONRPC framing (was jaja.py)
- src/rassumfrassum/test.py - Test utilities (was tete.py)
- src/rassumfrassum/util.py - Logging, helpers like dmerge (was lolo.py)

## Commit Style
- GNU ChangeLog format
- NO Claude footers (Co-Authored-By, etc.)
- Focus on WHAT changed, not HOW
- Keep descriptions concise

## Multi-server Feature Complexity
The completion support is a good example of how complex multi-server features can be:
- 4 separate pieces needed (capability merge, routing, stashing, aggregation)
- Each piece has edge cases and FIXMEs
- Should document this pattern in README.md as example
